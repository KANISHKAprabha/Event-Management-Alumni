{% extends 'base.html' %}
{% load static %}

{% block title %}Sign Up{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">

        <h2 class="mb-4 text-center fw-bold">üìù Create Your Account</h2>

        <form method="post" id="signup-form" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            {% for field in form %}
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    
                    {% for error in field.errors %}
                        <div class="text-danger small mt-1">{{ error }}</div>
                    {% endfor %}
                    {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text|safe }}</small>
                    {% endif %}
                </div>
            {% endfor %}

            <button type="submit" id="signup-btn" class="btn btn-primary btn-lg w-100 mt-3">
                Sign Up
            </button>
        </form>

        <div class="d-flex align-items-center my-4">
            <hr class="flex-grow-1">
            <span class="mx-3 text-muted small fw-bold">OR</span>
            <hr class="flex-grow-1">
        </div>

        <div class="text-center">
            <a id="google-btn" href="{% url 'social:begin' 'google-oauth2' %}?next={{ request.path }}" 
               class="btn btn-outline-secondary w-100">
                <i class="fab fa-google me-2"></i>
                Sign Up with Google
            </a>
        </div>

        <div class="text-center mt-4">
            <small class="text-muted">
                Already have an account? 
                <a href="{% if event %}{% url 'user_login' event_id=event.id %}{% else %}{% url 'event_overview' %}{% endif %}" 
                   class="text-decoration-none fw-bold">Login</a>
            </small>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // ---- SCRIPT TO AUTOMATICALLY STYLE DJANGO FORM FIELDS ----
    const signupForm = document.getElementById("signup-form");
    if (signupForm) {
        // Add 'form-control' to standard inputs
        const inputs = signupForm.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="url"], textarea, select');
        inputs.forEach(function(input) {
            input.classList.add('form-control');
        });

        // Add 'form-check-input' to checkboxes
        const checkboxes = signupForm.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(checkbox) {
            checkbox.classList.add('form-check-input');
            // Wrap checkbox and its label in a form-check div for proper alignment
            if (checkbox.parentElement.tagName !== 'DIV' || !checkbox.parentElement.classList.contains('form-check')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'form-check';
                checkbox.parentNode.insertBefore(wrapper, checkbox);
                wrapper.appendChild(checkbox);
                const label = signupForm.querySelector(`label[for="${checkbox.id}"]`);
                if (label) {
                    label.className = 'form-check-label';
                    wrapper.appendChild(label);
                }
            }
        });
    }

    // ---- YOUR ORIGINAL SCRIPT FOR BUTTON SUBMISSION ----
    const form = document.getElementById("signup-form");
    const signupBtn = document.getElementById("signup-btn");
    const googleBtn = document.getElementById("google-btn");

    // For normal signup form
    if (form) {
        form.addEventListener("submit", function() {
            if(signupBtn) {
                signupBtn.disabled = true;
                signupBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Signing up...';
            }
        });
    }

    // For Google signup
    if (googleBtn) {
        googleBtn.addEventListener("click", function(event) {
            if (googleBtn.dataset.clicked === "true") {
                event.preventDefault(); // prevent second click
            } else {
                googleBtn.dataset.clicked = "true";
                googleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Redirecting...';
            }
        });
    }
});
</script>
{% endblock %}